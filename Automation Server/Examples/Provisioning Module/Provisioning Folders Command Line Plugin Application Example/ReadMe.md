Testing command line provisioning plugin

1. Prerequisites:
	- Installed Atomia Automation Server on local machine in bootstrap mode.
	- Installed Atomia Command Line tool or Installed AutomationServerClient, as testing tool.
	- Installed Microsoft .NET Framework 4.0

	This comes with Atomia Automation Server installation but should be checked: 
	- Installing provisioning module for supporting command line plugins
		- Be shure that in Program Files (x86)/Atomia/AutomationServer/Common/Modules, exist file Atomia.Provisioning.Modules.CmdLocal.dll
		- Be shure that in Program Files (x86)/Atomia/AutomationServer/Common/Resources.xml file, there is resource description for CmdLocal module
		- Next two dlls should be in Program Files (x86)/Atomia/AutomationServer/Common/Modules folder: Atomia.Provisioning.Base.dll, Atomia.Provisioning.Base.Module.dll

2. Setting/Installing Provisioning Plugin Module example as command line application for provisioning folders
	- Download Provisioning Folders Example.zip, and unpack it
	- Build Atomia.Provisioning.Modules.Folders plugin, and copy compiled exe to (x86)/Atomia/AutomationServer/Common/Modules
		- We have prepared batch file CompileProject.bat, which will compile and copy plugin, you can start it and it will do job for you. It is possible that you should change paths in .bat file.
		
			- Anyway you can try to compile it by yourself typing similar like next in command line:
		
				c:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild "Atomia.Provisioning.Modules.Folders\Atomia.Provisioning.Modules.Folders.csproj" /p:Configuration=Release

				be aware that you should provide full path for csproj file, and be sure that c:\Windows is your system windows folder, if not please change it
		
			- also you can manualy copy file to automation server common/modules folder typing similar like next in command line:		
			
				copy "Atomia.Provisioning.Modules.Folders\bin\Release\Atomia.Provisioning.Modules.Folders.exe" "c:\Program Files (x86)\Atomia\AutomationServer\Common\Modules\" /y

				be aware that you should provide full path for .exe file, and be sure that commo\modules folder is right one

	- Add service description in ProvisioningDescription.xml and resource description into Resources.xml:
		- Add in ProvisioningDescription.xml next definition in SimpleServiceList section
		<simpleService name="Folders" friendlyName="Folders" providingModule="Atomia.Provisioning.Modules.CmdLocal.CmdLocal">
			<propertyList>
				<property name="Id" friendlyName="Id of the instance, generated by module." defaultValue="123" />
				<property name="Name" friendlyName="Folder Name" key="true" defaultValue="ChangeMe" />
				<property name="Description" friendlyName="General description." defaultValue="Change this default description value" />
				<property name="StdinStdout" friendlyName="Are commands going to accept and return JSON encoded service via stdin/stdout" defaultValue="false" required="true" />                    
				<property name="UseCmdLinePlugin" friendlyName="Are commands going to use plugin command line app for provisioning" defaultValue="true" required="true" />
				<property name="AddExecuteCmd" friendlyName="Command to be executed to add Folder, begin transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Add --RootFolder {resource[RootFolder]} --Name {service[Name]} --Description {service[Description]}" required="true" />
				<property name="AddCommitCmd"  friendlyName="Command to be executed to add Folder, commit transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Add --RootFolder {resource[RootFolder]} --Name {service[Name]} --Description {service[Description]}" required="true" />
				<property name="AddRollbackCmd" friendlyName="Command to be executed to add Folder, rollback transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Add --RootFolder {resource[RootFolder]} --Name {service[Name]} --Description {service[Description]}" required="true" />
				<property name="RemoveExecuteCmd" friendlyName="Command to be executed to remove Folder, begin transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Remove --RootFolder {resource[RootFolder]} --Name {service[Name]} --Description {service[Description]}" required="true" />
				<property name="RemoveCommitCmd" friendlyName="Command to be executed to remove Folder, commit transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Remove --RootFolder {resource[RootFolder]} --Name {service[Name]} --Description {service[Description]}" required="true" />
				<property name="RemoveRollbackCmd" friendlyName="Command to be executed to remove Folder, rollback transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Remove --RootFolder {resource[RootFolder]} --Name {service[Name]} --Description {service[Description]}" required="true" />
				<property name="ModifyExecuteCmd" friendlyName="Command to be executed to modify Folder, begin transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Modify --RootFolder {resource[RootFolder]} --Name {service[Name]} --Description {service[Description]}" required="true" />
				<property name="ModifyCommitCmd" friendlyName="Command to be executed to modify Folder, commit transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Modify --RootFolder {resource[RootFolder]} --Name {service[Name]} --Description {service[Description]}" required="true" />
				<property name="ModifyRollbackCmd" friendlyName="Command to be executed to modify Folder, rollback transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Modify --RootFolder {resource[RootFolder]} --Name {service[Name]} --Description {service[Description]}" required="true" />
				<property name="OperationMappingCmd" friendlyName="Define how opperations are executed" defaultValue="GetFullFolderPath:Atomia.Provisioning.Modules.Folders.exe --CallOp --RootFolder {resource[RootFolder]} --Name {service[Name]}" required="true" />
			</propertyList>
			<operationList>
				<operation name="GetFullFolderPath" />
			</operationList>
			<childServiceList>
				<simpleService name="Files" friendlyName="Files">
					<propertyList>
						<property name="Id" friendlyName="Id" defaultValue="123"/>
						<property name="Name" friendlyName="Name" defaultValue="TestFile.txt" key="true"/>
						<property name="ParentFolder" friendlyName="Parent folder" key="true" defaultValue="WillTakeValueFromParentService"/>
						<property name="Content" friendlyName="File content" defaultValue="123"/>
						<property name="TestChangesPropagation" friendlyName="TestChangesPropagation" defaultValue=""/>
						<property name="StdinStdout" friendlyName="Is command going to accept and return JSON encoded service via stdin/stdout" defaultValue="false" required="true" />
						<property name="UseCmdLinePlugin" friendlyName="Are commands going to use plugin command line app for provisioning" defaultValue="true" required="true" />
						<property name="AddExecuteCmd" friendlyName="Command to be executed to add File, begin transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Add --RootFolder {resource[RootFolder]} --Name {service[Name]} --ParentFolder {service[parent.Name]} --Content {service[Content]}" required="true" />
						<property name="AddCommitCmd"  friendlyName="Command to be executed to add File, commit transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Add --RootFolder {resource[RootFolder]} --Name {service[Name]} --ParentFolder {service[parent.Name]} --Content {service[Content]}" required="true" />
						<property name="AddRollbackCmd" friendlyName="Command to be executed to add File, rollback transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Add --RootFolder {resource[RootFolder]} --Name {service[Name]} --ParentFolder {service[parent.Name]} --Content {service[Content]}" required="true" />
						<property name="RemoveExecuteCmd" friendlyName="Command to be executed to remove File, begin transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Remove --RootFolder {resource[RootFolder]} --Name {service[Name]} --ParentFolder {service[parent.Name]} --Content {service[Content]}" required="true" />
						<property name="RemoveCommitCmd" friendlyName="Command to be executed to remove File, commit transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Remove --RootFolder {resource[RootFolder]} --Name {service[Name]} --ParentFolder {service[parent.Name]} --Content {service[Content]}" required="true" />
						<property name="RemoveRollbackCmd" friendlyName="Command to be executed to remove File, rollback transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Remove --RootFolder {resource[RootFolder]} --Name {service[Name]} --ParentFolder {service[parent.Name]} --Content {service[Content]}" required="true" />
						<property name="ModifyExecuteCmd" friendlyName="Command to be executed to modify File, begin transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Modify --RootFolder {resource[RootFolder]} --Name {service[Name]} --ParentFolder {service[parent.Name]} --Content {service[Content]}" required="true" />
						<property name="ModifyCommitCmd" friendlyName="Command to be executed to modify File, commit transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Modify --RootFolder {resource[RootFolder]} --Name {service[Name]} --ParentFolder {service[parent.Name]} --Content {service[Content]}" required="true" />
						<property name="ModifyRollbackCmd" friendlyName="Command to be executed to modify File, rollback transaction" defaultValue="Atomia.Provisioning.Modules.Folders.exe --Modify --RootFolder {resource[RootFolder]} --Name {service[Name]} --ParentFolder {service[parent.Name]} --Content {service[Content]}" required="true" />
						<property name="OperationMappingCmd" friendlyName="Define how opperations are executed" defaultValue="GetFullFilePath:Atomia.Provisioning.Modules.Folders.exe --CallOp --RootFolder {resource[RootFolder]} --Name {service[Name]} --ParentFolder {service[ParentFolder]}" required="true" />
					</propertyList>
					<operationList>
						<operation name="GetFullFilePath" />
					</operationList>
				</simpleService>
				<simpleService name="FilesWithoutPlugin" friendlyName="Files service, where files are provisioned without command line plugin application. Direct command line commands are used.">					
					<propertyList>
						<property name="Id" friendlyName="Id" defaultValue="123"/>
						<property name="Name" friendlyName="Name" defaultValue="TestFile.txt" key="true"/>
						<property name="ParentFolder" friendlyName="Parent folder" key="true" defaultValue="WillTakeValueFromParentService"/>
						<property name="Content" friendlyName="File content" defaultValue="123"/>                            
						<property name="StdinStdout" friendlyName="Is command going to accept and return JSON encoded service via stdin/stdout" defaultValue="false" required="true" />
						<property name="UseCmdLinePlugin" friendlyName="Are commands going to use plugin command line app for provisioning" defaultValue="false" required="true" />                            
						<property name="AddExecuteCmd" friendlyName="Command to be executed to add File, begin transaction" defaultValue="echo {service[Content]} > {resource[RootFolder]}{service[parent.Name]}\{service[Name]}" required="true" />
						<property name="AddCommitCmd"  friendlyName="Command to be executed to add File, commit transaction" defaultValue="" required="false" />
						<property name="AddRollbackCmd" friendlyName="Command to be executed to add File, rollback transaction" defaultValue="del {resource[RootFolder]}{service[parent.Name]}\{service[Name]}" required="true" />
						<property name="RemoveExecuteCmd" friendlyName="Command to be executed to remove File, begin transaction" defaultValue="ren {resource[RootFolder]}{service[parent.Name]}\{service[Name]} {service[Name]}_MarkedForDelete" required="true" />
						<property name="RemoveCommitCmd" friendlyName="Command to be executed to remove File, commit transaction" defaultValue="del {resource[RootFolder]}{service[parent.Name]}\{service[Name]}_MarkedForDelete" required="true" />
						<property name="RemoveRollbackCmd" friendlyName="Command to be executed to remove File, rollback transaction" defaultValue="ren {resource[RootFolder]}{service[parent.Name]}\{service[Name]}_MarkedForDelete {service[Name]}" required="true" />
						<property name="ModifyExecuteCmd" friendlyName="Command to be executed to modify File, begin transaction" defaultValue="ren {resource[RootFolder]}{oldservice[parent.Name]}\{oldservice[Name]} {newservice[Name]}" required="true" />
						<property name="ModifyCommitCmd" friendlyName="Command to be executed to modify File, commit transaction" defaultValue="" required="false" />
						<property name="ModifyRollbackCmd" friendlyName="Command to be executed to modify File, rollback transaction" defaultValue="ren {resource[RootFolder]}{newservice[parent.Name]}\{newservice[Name]} {oldservice[Name]}" required="true" />
						<property name="OperationMappingCmd" friendlyName="Define how opperations are executed" defaultValue="GetFullFilePath:echo {resource[RootFolder]}{service[parent.Name]}\{service[Name]}" required="true" />
					</propertyList>
					<operationList>
						<operation name="GetFullFilePath" />
					</operationList>
				</simpleService>
			</childServiceList>
		</simpleService>

		- In ProvisioningDescription.xml find <packageDescription>/<packageList> and find package named BasePackage. Under <serviceList> node, add <service name="Folders" />. In this way we set that our service 'Folder' is part of BasePackage, and later when we want to test it, we will find command for adding new 'Folder' service when we work with BasePackage.
		- Add in ResourceDescription in definition for Atomia.Provisioning.Modules.CmdLocal.dll module, in ResourcesList section:
			<resource name="Folders">
				<property name="RootFolder">c:\TestProvisioningExample\</property>
				<property name="ServiceName">Folders</property>
			</resource>

	- After changing xml files restart iis, typing iisreset in cmdprompt, so that automation server gets latest changes.
	
3. Testing Provisioning Plugin Module example - command line application for provisioning folders

	3.1 Testing using atomia command line tool
		
		- Add service:
			
			windows cmdprompt:
				atomia service add --account 100000 --servicedata "{ \"name\" : \"Folders\", \"properties\" : { \"Name\" : \"test123\", \"Description\" : \"test123 description\"}}"
			linux:
				atomia service add --account 100000 --servicedata '{ "name" : "Folders", "properties" : { "Name" : "test123", "Description" : "test123 description"}}'
				
			This command will provide new service and will add new folder with given name 'test123'. As output from command you will get newly created service data serialized. Find logical id and remember it, because we will need it for change and delete commands.
			We can check root folder, if you didn't change it in ResourceDescription.xml file, it is c:\TestProvisioningExample\, you will find folder 'test123' created.
		
		- Modify service:
			
			windows cmdprompt:
				atomia service modify --account 100000 --service "67e9a578-7151-4569-93a0-a1c98c165855" --servicedata "{ \"properties\" : { \"Name\" : \"testFolderWithChangedName\"}}"
			linux:
				atomia service modify --account 100000 --service "67e9a578-7151-4569-93a0-a1c98c165855" --servicedata '{ "properties" : { "Name" : "testFolderWithChangedName"}}'
				
			This command will provide change of existing service i.e. will rename existing folder 'test123' to 'testFolderWithChangedName'. serviceId used in this command "67e9a578-7151-4569-93a0-a1c98c165855" is one we get during testing, you must replace it with logicalid you writed down during add command testing.
			We can check our root folder and we will see that folder name is changed. So, change is provisioned. 
			
		- Delete service:
		
			windows cmdprompt:
				atomia service delete --account 100000 --service "67e9a578-7151-4569-93a0-a1c98c165855"
			linux:
				atomia service delete --account 100000 --service "67e9a578-7151-4569-93a0-a1c98c165855"
			
			This command will provide deleting of existing service with given service id. ServiceId used in this command "67e9a578-7151-4569-93a0-a1c98c165855" is one we get during testing, you must replace it with logicalid you writed down during add command testing.
			You can check if folder is realy deleted if you open our root folder. So, provisioning for delete service is passed succesfully.
	
	3.2 Testing using AutomationServerClient.exe
		Start AutomationServerClient.exe. If you start AutomationServerClient for first time, you should set package which is used for work. From menu open File -> New Package, choose BasePackage and press AddPackage button.
		Also, in ProvisioningDescription.xml find <packageDescription>/<packageList> and find package named BasePackage. Under <serviceList> node, add <service name="Folders" />. In this way we set that our service 'Folder' is part of BasePackage, and later when we want to test it, we will find command for adding new 'Folder' service when we work with BasePackage.
		
		Right mouse click on empty area in service list, Add Child Service -> Folders, change name for folder because that is key property and press OK butoon. New service will appears in list, and you can check in root folder, if you didn't change it in ResourceDescription.xml file, it is c:\TestProvisioningExample\, you will find folder with the same name as created service. 
		Next you can try to edit service, right click on it, start Edit Service popup menu command, Edit service form will appear. Change parameter Name, which represent name for folder and click OK. After refreshing service tree, we can see that service is changed, now have new name. Also we can check our root folder and we will see that folder name is changed. So, change is provisioned.
		At last you can try to delete service, right click on it, start Delete Service popup menu command, prompt will appear, press yes, and service will be deleted. You can check if folder is realy deleted if you open our root folder. So, provisioning for delete service is passed succesfully.
	