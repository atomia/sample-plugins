Instruction for developing and testing provisioning plugin

In our example we will develop simple provisioning plugin module for provisioning folders, named Atomia.Provisioning.Modules.Folders, using existing template project: Automation Server Plugin Module Template.

1. Prerequisites:
	- Installed Atomia Automation Server on local machine in bootstrap mode
	- Installed Microsoft .NET Framework 4.0
	- Installed Atomia Command Line tool or Installed AutomationServerClient, as testing tool.
	- Automation Server Plugin Module Template
	
	Please check if next two dlls should be in automation server instalation folder(Program Files (x86)/Atomia/AutomationServer)/Common/Modules folder: 
		Atomia.Provisioning.Base.dll, Atomia.Provisioning.Base.Module.dll
	If not copy them to folder.	
	
2. Prepare your plugin project
	- If .NET is used ther next should be instaled on machine:		
		- Visual Studio 2010
		- .NET Framework 4.0
		
	Download AtomiaAutomationServer SDK.zip, unpack it and copy 'Automation Server Plugin Module Template' folder to your working folder.
	Template must be changed a little, we will set project name, and namespaces so that your project gets its identity.
		- Open solution Atomia.Provisioning.Modules.Template.sln in visual studio, rename it to Atomia.Provisioning.Modules.<MyPlugin>.
		- Open project properties. Set AssemblyName, Default NameSpace, open AssemblyInformation and set Title and Product, all to Atomia.Provisioning.Modules.Folders value. It is recomendable that you change project GUID with valid guid.
		- Rename project to Atomia.Provisioning.Modules.Folders.
		- Rename file TemplateCommand.cs to FoldersCommand.cs, open file and rename namespace, class name and constructor in same way.
		- Rename Template.cs to Folders.cs, open file and rename namespace, class name and constructor in same way. Also rename 'Template' word in code to Folders.
			
3. Programming provisioning plugin
	3.1. Write FoldersCommand
	3.2. Change ProvisioningDescription.xml
	3.3. Change Resources.xml
	3.4. Build and install plugin
	3.5. Testing plugin	
	
	3.1. Plugin module class in our case is Folders.cs, inherits ModuleBase clas, and must implement interface defined in ModuleBase. In ModuleBase we have defined methods for comunication with Automatin server, and most important are: method for adding service(ProvideService), ModifyService, RemoveService, CallOperation, BeginTransaction, CommitTransaction, RollbackTransaction.
		These methods are called from automation server when some service request is created, and our job is to write code for them. In code pattern we used in template project, there is situation that for our example we don't need to change code in this class. Support for transactions is already implemented in existing code.
		Class we will change is FoldersCommand.cs. Our task is to write code for ExecuteAdd, ExecuteRemove, ExecuteModify and CallOperation methods.
		Already prepared code you can find in Atomia Automation Server SDK\Examples\ProvisioningModule\Provisioning Folders Plugin Module Example\. Code implements creating, renaming(modifying), deleting folders, and one operation for returning full folder path: GetFullFolderPath.
		Implementing such code for provisioning folders we have finished writing code for plugin module. Now we are redy for next step.
		
	3.2. We need to write service description for our Folders service, and to add it to ProvisioningDescription.xml file. Here is service description for our service:
		
			<simpleService name="Folders" friendlyName="Folders" providingModule="Atomia.Provisioning.Modules.Folders.Folders">
				<propertyList>
					<property name="Id" friendlyName="Id of the instance, generated by module." defaultValue="123" />
					<property name="Name" friendlyName="Folder Name" key="true" defaultValue="ChangeMe" />
					<property name="Description" friendlyName="General description." defaultValue="Change this default description value" />                
				</propertyList>
				<operationList>
					<operation name="GetFullFolderPath" />
				</operationList>
			</simpleService>
			
			We define service with name Folders, which use our plugin module dll Atomia.Provisioning.Modules.Folders for service provisioning. Service have few properties: Id, Name and description, where Name is property which will be provisioned to Folder on root folder(root folder will be defined in resource definition).
			Also we defined one operation for service: GetFullFolderPath. We don't need nothing more for our simple service for provisioning folders.
			
			Now we will add our service definition to ProvisioningDescription.xml, find this file in automation server instalation folder(Program Files (x86)/Atomia/AutomationServer)/Common/ProvisioningDescriptions, and find closing tag for </simpleServiceList>. Before it add our service description, save and close file.
			After changing .xml file we should reset iis on machine, so that automation server takes latest changes.
			
	3.3. We need to write resource description for our service, and to add it to Resources.xml file. When some service is provisioned, that is done on some resource. Resource parameters are defined in resource description for service, in our case:
			
			<bindings>
				<moduleList>
					<module name="Atomia.Provisioning.Modules.Folders.Folders" resourceAsignmentPolicy="RoundRobin" />
				</moduleList>
				<resourceList>					
					<resource name="Folders">
						<property name="RootFolder">c:\TestProvisioningExample\</property>						
					</resource>
				</resourceList>
			</bindings>
			
			For our folders service we have defined RootFolder property, which marks folder under which all service folders will be created. 
			
			Now we will add our resource description to Resources.xml file. Find this file in automation server instalation folder(Program Files (x86)/Atomia/AutomationServer)/Common/, and below tag <resourceDescription> add our resource description, save and close file.
			After changing .xml file we should reset iis on machine, so that automation server takes latest changes.
			
	3.4. Building plugin is easy as building any other project. Build it and for installing we only need to copy plugin module dll to automation server instalation folder(Program Files (x86)/Atomia/AutomationServer)/Common/Modules folder. If you have some dependencies you should copy them too to the same folder.
			
	3.5. Testing plugin		

		3.1 Testing using atomia command line tool
		
			- Add service:
				
				windows cmdprompt:
					atomia service add --account 100000 --servicedata "{ \"name\" : \"Folders\", \"properties\" : { \"Name\" : \"test123\", \"Description\" : \"test123 description\"}}"
				linux:
					atomia service add --account 100000 --servicedata '{ "name" : "Folders", "properties" : { "Name" : "test123", "Description" : "test123 description"}}'
					
				This command will provide new service and will add new folder with given name 'test123'. As output from command you will get newly created service data serialized. Find logical id and remember it, because we will need it for change and delete commands.
				We can check root folder, if you didn't change it in ResourceDescription.xml file, it is c:\TestProvisioningExample\, you will find folder 'test123' created.
			
			- Modify service:
				
				windows cmdprompt:
					atomia service modify --account 100000 --service "67e9a578-7151-4569-93a0-a1c98c165855" --servicedata "{ \"properties\" : { \"Name\" : \"testFolderWithChangedName\"}}"
				linux:
					atomia service modify --account 100000 --service "67e9a578-7151-4569-93a0-a1c98c165855" --servicedata '{ "properties" : { "Name" : "testFolderWithChangedName"}}'					
					
				This command will provide change of existing service i.e. will rename existing folder 'test123' to 'testFolderWithChangedName'. serviceId used in this command "67e9a578-7151-4569-93a0-a1c98c165855" is one we get during testing, you must replace it with logicalid you writed down during add command testing.
				We can check our root folder and we will see that folder name is changed. So, change is provisioned. 
				
			- Delete service:
			
				windows cmdprompt:
					atomia service delete --account 100000 --service "67e9a578-7151-4569-93a0-a1c98c165855"
				linux:
					atomia service delete --account 100000 --service "67e9a578-7151-4569-93a0-a1c98c165855"
				
				This command will provide deleting of existing service with given service id. ServiceId used in this command "67e9a578-7151-4569-93a0-a1c98c165855" is one we get during testing, you must replace it with logicalid you writed down during add command testing.
				You can check if folder is realy deleted if you open our root folder. So, provisioning for delete service is passed succesfully.
		
		3.2 Testing using AutomationServerClient.exe
			Start AutomationServerClient.exe. 
			If you start AutomationServerClient for first time, you should set package which is used for work. From menu open File -> New Package, choose BasePackage and press AddPackage button.
			Also, in ProvisioningDescription.xml find <packageDescription>/<packageList> and find package named BasePackage. Under <serviceList> node, add <service name="Folders" />. In this way we set that our service 'Folder' is part of BasePackage, and later when we want to test it, we will find command for adding new 'Folder' service when we work with BasePackage.
		
			Right mouse click on empty area in service list, Add Child Service -> Folders, change name for folder because that is key property and press OK butoon. New service will appears in list, and you can check in root folder, if you didn't change it in ResourceDescription.xml file, it is c:\TestProvisioningExample\, you will find folder with the same name as created service. 
			Next you can try to edit service, right click on it, start Edit Service popup menu command, Edit service form will appear. Change parameter Name, which represent name for folder and click OK. After refreshing service tree, we can see that service is changed, now have new name. Also we can check our root folder and we will see that folder name is changed. So, change is provisioned.
			At last you can try to delete service, right click on it, start Delete Service popup menu command, prompt will appear, press yes, and service will be deleted. You can check if folder is realy deleted if you open our root folder. So, provisioning for delete service is passed succesfully.
		
			
			
		
